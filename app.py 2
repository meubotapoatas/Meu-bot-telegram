import os
import requests
import telebot
from datetime import datetime

# Carrega variáveis de ambiente do Render
BOT_TOKEN = os.getenv("BOT_TOKEN")
ODDS_API_KEY = os.getenv("ODDS_API_KEY")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")

bot = telebot.TeleBot(BOT_TOKEN)

def buscar_palpites():
    url = "https://api.the-odds-api.com/v4/sports/soccer/odds"
    params = {
        "apiKey": ODDS_API_KEY,
        "regions": "eu",
        "markets": "h2h,totals",
        "oddsFormat": "decimal",
        "dateFormat": "iso"
    }

    try:
        resp = requests.get(url, params=params)
        data = resp.json()

        palpites = []
        for jogo in data:
            competicao = jogo.get("sport_title", "Desconhecido")
            time1 = jogo["home_team"]
            time2 = jogo["away_team"]
            sites = jogo.get("bookmakers", [])

            if not sites:
                continue

            melhor_odd = 0
            melhor_time = ""
            for site in sites:
                for mercado in site["markets"]:
                    if mercado["key"] == "h2h":
                        for outcome in mercado["outcomes"]:
                            if outcome["price"] >= 1.8 and outcome["price"] > melhor_odd:
                                melhor_odd = outcome["price"]
                                melhor_time = outcome["name"]

            if melhor_time:
                palpites.append(f"🏆 {competicao}\n{time1} vs {time2}\n💡 Sugestão: {melhor_time}\n💰 Odd: {melhor_odd}")

        return palpites

    except Exception as e:
        return [f"Erro ao buscar palpites: {str(e)}"]

@bot.message_handler(commands=["palpites"])
def enviar_palpites(message):
    palpites = buscar_palpites()
    if palpites:
        for p in palpites[:5]:  # Envia no máximo 5 palpites
            bot.send_message(CHAT_ID, p)
    else:
        bot.send_message(CHAT_ID, "Nenhum palpite encontrado no momento.")

if __name__ == "__main__":
    bot.infinity_polling()
